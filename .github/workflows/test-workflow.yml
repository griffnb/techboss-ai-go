name: Test Workflow

on:
  workflow_dispatch:
  


permissions:
  # Required: allow read access to the content for analysis.
  contents: read
  # Optional: allow read access to pull request. Use with `only-new-issues` option.
  pull-requests: read

jobs:
 
  run-action:
    runs-on: ubuntu-latest
    env:
        REGION: us-east-1
        SYS_ENV: unit_test
        CONFIG_FILE: ${{ github.workspace }}/infra/unit_test.json
        GITHUB_ACTIONS: true

    services:
        postgres:
            image: postgres:15.1
            ports:
                - 5432:5432
            env:
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: postgres
                POSTGRES_DB: unit_test
        dynamodb:
            image: amazon/dynamodb-local
            ports:
                - 8000:8000
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
            go-version-file: go.mod

      - name: Authenticate to GitHub and Install Deps
        env:
          GOPRIVATE: github.com/CrowdShield/*
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CI_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config --global url."git@github.com:".insteadOf "https://github.com/"
          go mod download
      - name: Start LocalStack
        uses: LocalStack/setup-localstack@v0.2.3
        with:
          image-tag: 'latest'
          install-awslocal: 'true'

      - name: Run Migrations
        run: go run ./cmd/migrations

      - name: Validate System
        run: go run ./cmd/runner test 
